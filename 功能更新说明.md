# 医院挂号管理系统 - 功能更新说明

## 更新概述

本次更新实现了基于角色的权限管理系统，为管理员、医生和患者三种角色分别提供了相应的功能模块。

## 一、权限管理系统

### 1. 后端权限控制

- **权限拦截器** (`AuthInterceptor.java`)
  - 实现了基于JWT Token的身份验证
  - 支持基于角色的权限控制（`@RequireRole`注解）
  - 自动验证用户角色，防止未授权访问

- **角色注解** (`@RequireRole`)
  - 支持在Controller类和方法上使用
  - 可指定允许访问的角色类型（1-患者，2-医生，3-管理员）

### 2. 前端路由守卫

- 实现了路由级别的权限控制
- 根据用户角色自动显示/隐藏菜单项
- 未登录用户访问受保护页面时自动跳转到登录页

## 二、管理员功能模块

### 1. 医生信息管理
- 查询医生列表（支持按科室筛选）
- 创建、更新、删除医生信息
- 管理医生职称、专长、简介等信息

### 2. 患者信息管理
- 查询患者列表（支持关键词搜索）
- 创建、更新、删除患者信息
- 查看患者档案和诚信度信息

### 3. 科室信息管理
- 查询科室列表
- 创建、更新、删除科室信息
- 管理科室编码、描述等信息

### 4. 诊室信息管理
- 查询诊室列表（支持按科室筛选）
- 创建、更新、删除诊室信息
- 管理诊室编号、位置、所属医生等信息

### 5. 号源池管理
- 查询排班列表（支持多条件筛选）
- 创建、更新、删除排班信息
- 管理号源总数、已预约数等信息

### 6. 预约时段管理
- 查看系统预定义的预约时段列表
- 时段格式：08:00-09:00, 09:00-10:00等

### 7. 修改个人密码
- 管理员可以修改自己的登录密码
- 需要验证原密码

### 8. 查询功能
- 所有管理功能都支持查询操作
- 支持多条件组合查询

## 三、医生功能模块

### 1. 基本信息查询
- 查看本人信息（姓名、职称、专长等）
- 查看本人号源信息（总号源数、已预约数、剩余号源）
- 查看本人排班信息（按日期排序）

### 2. 调班管理
- 申请调整排班（修改日期或时段）
- 申请停诊（新日期为空时自动停诊）
- 查看调班申请状态（待审核、已通过、已拒绝）
- 填写调班原因

### 3. 患者队列查询
- 查看当天预约的患者队列
- 支持按日期查询
- 显示预约号、时间段、状态等信息

## 四、患者功能模块（预约管理子系统）

### 1. 信息查询
- 按科室查询号源情况
- 按医生查询号源情况
- 按日期查询可用时段

### 2. 挂号预约
- 选择科室、医生、日期、时段进行预约
- 自动生成预约号
- 预约成功后进入待支付状态

### 3. 取消预约
- 已预约的挂号可以取消
- 取消后自动释放号源
- 取消操作会影响诚信度

### 4. 修改预约
- 可以调整预约的时段
- 可以更换医生（通过选择新的排班）
- 修改时自动释放原号源并占用新号源

### 5. 诚信度查询
- 查看个人预约信誉度分数（0-100分）
- 显示总预约数、已完成数、已取消数
- 显示取消率和诚信等级（优秀、良好、一般、较差、差）
- 取消率超过30%会降低诚信度

## 五、查询与统计分析子系统

### 1. 预约统计（管理员）
- 统计总预约数、待支付、已预约、已取消、已完成数量
- 按日期统计预约情况
- 按科室统计预约情况
- 支持时间范围筛选

### 2. 排班统计（管理员）
- 统计总排班数、总号源数、已预约数、剩余号源
- 计算号源利用率
- 支持时间范围筛选

### 3. 报表生成
- 生成预约统计报表
- 生成排班统计报表
- 包含统计时间范围
- 支持打印功能（前端实现）

## 六、数据库更新

### 新增表

1. **consulting_room（诊室表）**
   - 诊室编号、名称、所属科室、所属医生、位置、状态等

2. **schedule_adjustment（调班申请表）**
   - 医生ID、排班ID、原日期/时段、新日期/时段、原因、状态、审核信息等

### 字段更新

1. **patient表**
   - 新增 `credit_score` 字段（诚信度分数，默认100）

### 测试数据

- 管理员账号：admin / password（密码：123456的BCrypt加密）
- 医生账号：doctor001, doctor002（密码：123456的BCrypt加密）
- 患者账号：patient001（密码：123456的BCrypt加密）

## 七、前端更新

### 1. API接口
- `admin.ts` - 管理员相关API
- `doctor.ts` - 医生相关API
- `statistics.ts` - 统计分析API
- 更新了 `appointment.ts` 和 `patient.ts`

### 2. 页面组件
- `AdminDashboard.vue` - 管理员控制台
- 更新了 `MyAppointments.vue` - 添加修改预约和诚信度查询
- 更新了 `App.vue` - 根据用户角色显示不同菜单

### 3. 路由更新
- 添加了管理员路由（/admin/*）
- 添加了医生路由（/doctor/*）
- 实现了路由守卫，进行权限验证

### 4. 表单验证
- 注册表单已实现完整的JS验证
  - 姓名、身份证号、手机号必填验证
  - 身份证号格式验证（18位）
  - 手机号格式验证（11位，1开头）
  - 密码长度验证（6-20位）
  - 确认密码一致性验证
- 其他表单也使用了Element Plus的验证规则

## 八、安全性增强

1. **后端安全**
   - JWT Token认证
   - 密码BCrypt加密存储
   - 基于角色的访问控制（RBAC）
   - 权限拦截器防止未授权访问

2. **前端安全**
   - Token存储在localStorage
   - 请求拦截器自动添加Token
   - 路由守卫验证登录状态和角色权限
   - 401错误自动清除Token并跳转登录

## 九、技术实现

### 后端技术栈
- Spring Boot
- MyBatis Plus
- Spring Security
- JWT
- BCrypt密码加密

### 前端技术栈
- Vue 3
- TypeScript
- Element Plus
- Vue Router
- Axios

## 十、使用说明

### 管理员登录
1. 使用管理员账号登录（admin/123456）
2. 进入管理员控制台
3. 可以管理医生、患者、科室、诊室、号源等信息
4. 可以查看统计报表

### 医生登录
1. 使用医生账号登录（doctor001/123456）
2. 查看本人信息和排班
3. 申请调班或停诊
4. 查看患者预约队列

### 患者登录
1. 注册账号或使用患者账号登录
2. 查询号源并预约
3. 查看和管理自己的预约
4. 查看个人诚信度

## 十一、数据库更新脚本

执行 `sql/update_schema.sql` 脚本来更新数据库结构：
- 添加诊室表
- 添加调班申请表
- 添加患者诚信度字段
- 插入测试账号

## 十二、注意事项

1. 首次使用需要执行数据库更新脚本
2. 所有密码默认都是123456（BCrypt加密后存储）
3. 前端需要配置正确的API地址
4. 确保后端服务正常运行
5. 确保数据库连接正常

## 十三、后续优化建议

1. 添加更多统计图表（使用ECharts）
2. 实现报表导出功能（Excel、PDF）
3. 添加操作日志记录
4. 实现消息通知功能
5. 优化前端页面布局和用户体验
6. 添加更多表单验证规则
7. 实现数据分页功能
8. 添加搜索和筛选功能优化

