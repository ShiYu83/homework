## 软件详细设计文档

### 核心类设计

#### 患者管理相关类

java

```
// 患者实体类
public class Patient {
    private Long id;
    private String name;
    private String idCard;
    private String phone;
    private Integer gender;
    private Date birthday;
    private String allergyHistory;
    private Date createTime;
    private Date updateTime;
}

// 患者服务类
@Service
public class PatientService {
    public Patient register(PatientRegisterDTO dto);
    public Patient getById(Long id);
    public void updateInfo(PatientUpdateDTO dto);
    public List<Patient> getFamilyMembers(Long userId);
}
```

#### 预约相关类

java

```
// 预约实体类
public class Appointment {
    private Long id;
    private Long patientId;
    private Long doctorId;
    private Long scheduleId;
    private String appointmentNo;
    private LocalDate appointmentDate;
    private String timeSlot;
    private Integer status; // 1-待支付 2-已预约 3-已取消 4-已完成
    private BigDecimal fee;
    private LocalDateTime cancelTime;
    private String cancelReason;
    private LocalDateTime paymentTime;
    private LocalDateTime completeTime;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

// 预约服务类
@Service
public class AppointmentService {
    public Appointment create(AppointmentCreateDTO dto);
    public void cancel(Long appointmentId, String reason);
    public Appointment modify(Long appointmentId, Long newScheduleId, String newTimeSlot);
    public List<Appointment> queryByPatient(Long patientId);
    public List<TimeSlotDTO> getAvailableSlots(Long departmentId, Long doctorId, String date);
    public Appointment getById(Long id);
}
```

#### 病例相关类

java

```
// 病例实体类
public class MedicalRecord {
    private Long id;
    private Long appointmentId;
    private Long patientId;
    private Long doctorId;
    private String diagnosis;
    private String symptoms;
    private String advice;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

// 病例服务类
@Service
public class MedicalRecordService {
    public MedicalRecord createMedicalRecord(MedicalRecord record);
    public MedicalRecord getMedicalRecordByAppointmentId(Long appointmentId);
    public List<MedicalRecord> getMedicalRecordsByPatientId(Long patientId);
    public List<MedicalRecord> getMedicalRecordsByDoctorId(Long doctorId);
}
```

#### 处方相关类

java

```
// 处方实体类
public class Prescription {
    private Long id;
    private Long medicalRecordId;
    private Long appointmentId;
    private BigDecimal totalAmount;
    private Integer status; // 1-待支付 2-已支付
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

// 处方明细实体类
public class PrescriptionItem {
    private Long id;
    private Long prescriptionId;
    private Long medicineId;
    private Integer quantity;
    private BigDecimal price;
    private BigDecimal subtotal;
    private LocalDateTime createTime;
}

// 处方服务类
@Service
public class PrescriptionService {
    public Prescription createPrescription(Long medicalRecordId, Long appointmentId, List<PrescriptionItem> items);
    public Map<String, Object> getPrescriptionDetail(Long id);
    public Prescription getPrescriptionByAppointmentId(Long appointmentId);
    public List<Prescription> getPrescriptionsByPatientId(Long patientId);
    public List<Prescription> getAllPrescriptions();
}
```

#### 支付相关类

java

```
// 支付订单实体类
public class Payment {
    private Long id;
    private Long appointmentId;
    private String orderNo;
    private BigDecimal amount;
    private Integer paymentMethod; // 1-微信 2-支付宝 3-医保 4-现金
    private Integer status; // 1-待支付 2-已支付 3-已退款
    private LocalDateTime payTime;
    private Integer orderType; // 1-挂号费 2-药品费 3-合并订单
    private Long prescriptionId;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

#### 药品相关类

java

```
// 药品实体类
public class Medicine {
    private Long id;
    private String name;
    private BigDecimal price;
    private String unit;
    private String specification;
    private Integer stock;
    private Integer status; // 0-下架 1-上架
    private String category;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

// 药品服务类
@Service
public class MedicineService {
    public List<Medicine> getAllMedicines();
    public List<Medicine> getAvailableMedicines(String keyword);
    public Medicine getMedicineById(Long id);
    public Medicine createMedicine(Medicine medicine);
    public Medicine updateMedicine(Medicine medicine);
    public void deleteMedicine(Long id);
    public void updateStatus(Long id, Integer status);
}
```

### 关键业务流程

#### 预约挂号流程

text

```
1. 患者登录系统
2. 选择科室/医生
3. 查询可预约时间
4. 选择时间段
5. 确认预约信息
6. 支付挂号费
7. 生成预约记录
8. 发送预约成功通知
```

####  排班生成流程

text

```
1. 科室管理员设置排班模板
2. 系统自动生成下周排班
3. 医生确认/调整个人排班
4. 生成号源数据
5. 发布可预约排班
```

### API接口设计

####  预约相关接口

**查询可预约号源**

text

```
GET /api/appointment/available-slots
Request:
{
  "departmentId": 1,
  "doctorId": 1,
  "date": "2024-01-15"
}
Response:
{
  "code": 200,
  "data": [
    {
      "scheduleId": 1,
      "timeSlot": "09:00-09:30",
      "remaining": 5
    }
  ]
}
```

**创建预约**

text

```
POST /api/appointment/create
Request:
{
  "patientId": 1,
  "scheduleId": 1,
  "doctorId": 1,
  "appointmentDate": "2024-01-15",
  "timeSlot": "09:00-09:30"
}
Response:
{
  "code": 200,
  "message": "预约成功",
  "data": {
    "id": 1,
    "appointmentNo": "202401150001",
    "status": 1,
    "fee": 25.00
  }
}
```

**修改预约**

text

```
PUT /api/appointment/modify/{id}
Request:
{
  "scheduleId": 2,
  "timeSlot": "10:00-10:30"
}
Response:
{
  "code": 200,
  "message": "修改成功",
  "data": { ... }
}
```

**取消预约**

text

```
PUT /api/appointment/cancel/{id}?reason=临时有事
Response:
{
  "code": 200,
  "message": "取消成功",
  "data": null
}
```

#### 病例相关接口

**创建病例**

text

```
POST /api/medical-record
Request:
{
  "appointmentId": 1,
  "diagnosis": "感冒",
  "symptoms": "咳嗽、流鼻涕",
  "advice": "多休息，多喝水"
}
Response:
{
  "code": 200,
  "message": "病例创建成功",
  "data": { ... }
}
```

**根据预约ID获取病例**

text

```
GET /api/medical-record/appointment/{appointmentId}
Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "diagnosis": "感冒",
    "symptoms": "咳嗽、流鼻涕",
    "advice": "多休息，多喝水"
  }
}
```

#### 处方相关接口

**创建处方**

text

```
POST /api/prescription
Request:
{
  "medicalRecordId": 1,
  "appointmentId": 1,
  "items": [
    {
      "medicineId": 1,
      "quantity": 2,
      "price": 9.90,
      "subtotal": 19.80
    }
  ]
}
Response:
{
  "code": 200,
  "message": "处方创建成功",
  "data": {
    "id": 1,
    "totalAmount": 19.80,
    "status": 1
  }
}
```

**获取处方详情**

text

```
GET /api/prescription/{id}
Response:
{
  "code": 200,
  "data": {
    "prescription": { ... },
    "items": [
      {
        "medicineName": "999感冒灵",
        "quantity": 2,
        "price": 9.90,
        "subtotal": 19.80
      }
    ]
  }
}
```

#### 支付相关接口

**创建支付订单**

text

```
POST /api/payment/create?appointmentId=1&amount=25.00
Response:
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "id": 1,
    "orderNo": "PAY1234567890",
    "amount": 25.00,
    "status": 1
  }
}
```

**执行支付**

text

```
POST /api/payment/pay?paymentId=1&paymentMethod=1
Response:
{
  "code": 200,
  "message": "支付成功",
  "data": null
}
```

**创建合并订单（挂号费+药品费）**

text

```
POST /api/payment/create-combined
Request:
{
  "appointmentId": 1,
  "prescriptionId": 1
}
Response:
{
  "code": 200,
  "message": "合并订单创建成功",
  "data": {
    "id": 1,
    "orderNo": "PAY1234567890",
    "amount": 44.80,
    "orderType": 3
  }
}
```

#### 药品相关接口

**获取可用药品**

text

```
GET /api/medicine/available?keyword=感冒
Response:
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "999感冒灵",
      "price": 9.90,
      "stock": 100,
      "status": 1
    }
  ]
}
```